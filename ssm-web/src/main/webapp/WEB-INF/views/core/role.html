#parse("header-top.html")<link rel="stylesheet" href="$res/components/_mod/jquery-ui/jquery-ui.min.css"/><link rel="stylesheet" href="$res/components/bootstrap-datepicker/dist/css/bootstrap-datepicker3.css"/><link rel="stylesheet" href="$res/components/_mod/jqgrid/ui.jqgrid.css"/>#parse("sub-header-bottom.html")<style>    .ui-jqgrid .tree-wrap-ltr {        float: left;        padding-top: 2px;    }</style><!-- /section:basics/navbar.layout --><div class="main-container ace-save-state" id="main-container">    <script type="text/javascript">        try {            ace.settings.loadState('main-container')        } catch (e) {        }    </script>    <!-- /section:basics/sidebar -->    <div class="main-content">        <div class="main-content-inner">            <div class="page-content-iframe">                <div class="row">                    <div class="col-xs-12">                        <!-- PAGE CONTENT BEGINS -->                        <div class="row">                            <div class="col-xs-12">                                <button class="create btn btn-pink btn-sm pull-right">新增角色</button>                                <button class="refresh btn btn-warning btn-sm">刷新<i class="ace-icon fa fa-refresh align-iddle bigger-125"></i></button>                            </div>                        </div>                        <div class="row">                            <div class="col-xs-12">                                <table id="grid-table"></table>                            </div><!-- /.col -->                        </div>                        <!-- PAGE CONTENT ENDS -->                    </div><!-- /.col -->                </div><!-- /.row -->            </div><!-- /.page-content -->        </div>    </div><!-- /.main-content --></div><!-- /.main-container --><div class="role-dialog bootbox modal fade in" tabindex="-1" role="dialog" aria-hidden="false"     style="display: none;padding-top: 20px;">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="bootbox-close-button close">×</button>                <h4 class="modal-title"></h4>            </div>            <div class="modal-body">                <div class="bootbox-body">                    <form class="form-horizontal role-form" method="get" novalidate="novalidate">                        <input type="hidden" name="id" id="id">                        <div class="form-group">                            <label class="control-label col-xs-12 col-sm-3 no-padding-right" for="name">角色名称:</label>                            <div class="col-xs-12 col-sm-9">                                <div class="clearfix">                                    <input type="text" name="name" id="name" class="col-xs-12 col-sm-6">                                </div>                            </div>                        </div>                        <div class="space-2"></div>                        <div class="form-group">                            <label class="control-label col-xs-12 col-sm-3 no-padding-right" for="sign">角色标识:</label>                            <div class="col-xs-12 col-sm-9">                                <div class="clearfix">                                    <input type="text" name="sign" id="sign" class="col-xs-12 col-sm-4">                                </div>                            </div>                        </div>                        <div class="space-2"></div>                        <div class="form-group">                            <label class="control-label col-xs-12 col-sm-3 no-padding-right" for="desc">角色描述:</label>                            <div class="col-xs-12 col-sm-9">                                <div class="clearfix">                                    <textarea id="desc" name="desc" cols="40" rows="5"></textarea>                                </div>                            </div>                        </div>                    </form>                </div>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-sm btn-primary bootbox-save-button">                    <i class="icon-ok"></i>保存                </button>                <button type="button" class="btn btn-sm bootbox-close-button">                    <i class="icon-remove red"></i>取消                </button>            </div>        </div>    </div></div><div class="role-menu-dialog bootbox modal fade in" tabindex="-1" role="dialog" aria-hidden="false"     style="display: none;padding-top: 20px;">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="bootbox-close-button close">×</button>                <h4 class="modal-title">设置角色菜单</h4>            </div>            <div class="modal-body">                <div class="bootbox-body">                    <div class="menu-tree tree"></div>                </div>            </div>            <div class="modal-footer">                <div class="checkbox pull-left">                    <label>                        <input name="form-field-checkbox" id="checkAllData" type="checkbox"                               class="ace icon icon-check-empty">                        <span class="lbl"> 全选</span>                    </label>                </div>                <button type="button" class="btn btn-sm btn-primary role-menu-save-button">                    <i class="icon-ok"></i>保存                </button>                <button type="button" class="btn btn-sm bootbox-close-button">                    <i class="icon-remove red"></i>取消                </button>            </div>        </div>    </div></div><div class="role-menu-permission-dialog bootbox modal fade in" tabindex="-1" role="dialog" aria-hidden="false"     style="display: none;padding-top: 20px;">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="bootbox-close-button close">×</button>                <h4 class="modal-title">设置角色菜单权限</h4>            </div>            <div class="modal-body">                <div class="bootbox-body">                    <div class="role-menu-permission-list"></div>                </div>            </div>            <div class="modal-footer">                <div class="checkbox pull-left">                    <label>                        <input name="form-field-checkbox" id="checkAllPermissionData" type="checkbox"                               class="ace icon icon-check-empty">                        <span class="lbl"> 全选</span>                    </label>                </div>                <button type="button" class="btn btn-sm btn-primary role-menu-permission-save-button">                    <i class="icon-ok"></i>保存                </button>                <button type="button" class="btn btn-sm bootbox-close-button">                    <i class="icon-remove red"></i>取消                </button>            </div>        </div>    </div></div>#parse("footer-top.html")<!-- 页面特定的插件脚本 --><script src="$res/components/bootstrap-datepicker/dist/js/bootstrap-datepicker.js"></script><script src="$res/components/jqGrid/js/jquery.jqGrid.js"></script><script src="$res/components/jqGrid/js/i18n/grid.locale-cn.js"></script><script src="$res/components/bootbox.js/bootbox.min.js"></script><script src="$res/components/_mod/fuelux/tree.js"></script>#parse("footer-bottom.html")<!-- 与此页面相关的内联脚本 --><script type="text/javascript">    var grid, validate, formData = {}, _data, treeObj, roleId, currRoleId, currMenuId;    var grid_selector = "#grid-table";    var formObj = '.role-form';    var dialogObj = '.role-dialog';    var roleMenuDialog = '.role-menu-dialog';    var roleMenuPermissionDialog = '.role-menu-permission-dialog';    var menuTree = '.menu-tree';    $(function ($) {        enableTooltips('.widget-header', '.action-buttons');        $('.bootbox-save-button').on('click', function () {            if (!$(formObj).valid()) return false;            var url = '/core/role/add?d=' + new Date().getTime();            var id = $('#id').val();            if (id) {                url = '/core/role/update?d=' + new Date().getTime()            }            var data = $(formObj).serializeObject();            http.post(url, data, function (r) {                drawGrid(grid,{fromServer: true, page: 1});                //$(grid_selector).trigger("reloadGrid", {fromServer: true, page: 1});                showSuccessTips("数据保存成功.");                $(dialogObj).modal('hide');            });        });        $('.role-menu-save-button').on('click', function () {            var ids = [];            var items = $(menuTree).tree('selectedAllItems');            for (var i in items) if (items.hasOwnProperty(i)) {                var item = items[i];                var id = item['id'];                ids.push(id);            }            var data = {roleId: roleId, menuId: ids.join(',')};            var url = '/core/roleMenu/save?d=' + new Date().getTime();            http.post(url, data, function (r) {                //$(grid_selector).trigger("reloadGrid", {fromServer: true, page: 1});                drawGrid(grid,{fromServer: true, page: 1});                showSuccessTips("数据保存成功.");                $(dialogObj).modal('hide');            });            cleanTree();            $(roleMenuDialog).modal('hide');        });        $('.role-menu-permission-save-button').on('click', function () {            var nodes = $('.role-menu-permission-list input[type="checkbox"]:checked');//获取所有选中节点对象            var array = [];            var signArray = [];            if (nodes && nodes.length > 0) {                $.each(nodes, function (i, item) {                    array.push($(item).val());                    signArray.push($(item).data('sign'));                });            }            var data = {                roleId: currRoleId,                menuId: currMenuId,                permissionId: array.join(","),                permissionSign: signArray.join(",")            };            var url = '/core/roleMenuPermission/add';            http.post(url, data, function (r) {                showSuccessTips("角色菜单权限保存成功.");                $(roleMenuPermissionDialog).modal('hide');            });        });        $('#checkAllData').on('click', function () {            $(menuTree).tree('checkAllItem', this.checked);        });        initJqgridSize(grid_selector);        grid = $(grid_selector).jqGrid({            url: ctx+"/core/role/query",            datatype: "json",            mtype: 'post',            height: 'auto',            colNames: ['', '数据名称', '数据编码', '角色标识', '菜单描述', '创建人', '创建日期', '更新人', '更新日期', '操作'],            colModel: [                {name: 'parent', hidden: true},                {name: 'entity.name', width: 90, editable: false, sortable: false},                {name: 'entity.id', width: 60, sorttype: 'text', editable: false, sortable: false},                {name: 'entity.sign', width: 100, editable: false, sortable: false},                {name: 'entity.desc', width: 100, editable: false},                {name: 'entity.creator', width: 50, editable: false, sortable: false},                {name: 'entity.createTime', index: 'createTime', width: 60, sorttype: 'date', editable: false},                {name: 'entity.updateBy', width: 50, editable: false, sortable: false},                {name: 'entity.updateTime', index: 'updateTime', width: 60, sorttype: 'date', editable: false},                {                    name: 'myac', width: 140, fixed: true, sortable: false, resize: false,                    formatter: formatOptions                }            ],            viewrecords: true,            altRows: true,            //toppager: true,            multiselect: false,            //multikey: "ctrlKey",            multiboxonly: true,            hoverrows: false,            loadonce: false,            scrollrows: true,            // enable tree grid            treeGrid: true,            // which column is expandable            ExpandColumn: "entity.name",            ExpandColClick: true,            // the model used            treeGridModel: "adjacency",            jsonReader: {                repeatitems: false            },            treeIcons: {                plus: 'fa fa-folder blue',                minus: 'fa fa-folder-open blue'            },            treeReader: {                level_field: "level",                parent_id_field: "parent",                leaf_field: "leaf",                expanded_field: "expanded",                icon_field: "icon",                loaded: "loaded"            },            caption: "角色列表",            loadComplete: function (data) {                $('body').hideLoading();                _data = data;                var table = this;                setTimeout(function () {                    enableTooltips(table, '.ui-pg-div');                }, 0);                resetIframeHeight();            },            onSelectRow :function (rowid, status  ){                resetIframeHeight();            }, onSortCol: function (index, colindex, sortorder) {                $(grid_selector).jqGrid('setGridParam', {page: 1}).trigger("reloadGrid");            }        });        $(window).triggerHandler('resize.jqGrid');//trigger window resize to make the grid get the correct size        $(document).one('ajaxloadstart.page', function (e) {            $.jgrid.gridDestroy(grid_selector);            $('.ui-jqdialog').remove();        });        validate = $(formObj).validate({            errorElement: 'div',            errorClass: 'help-block',            focusInvalid: false,            rules: {                name: {required: true},                sign: {required: true}            },            messages: {                name: {required: "角色名称不能为空."},                sign: {required: "角色标识不能为空."}            },            invalidHandler: function (event, validator) { //display error alert on form submit                $('.alert-danger', $('.role-form')).show();            },            highlight: function (e) {                $(e).closest('.form-group').removeClass('has-info').addClass('has-error');            },            success: function (e) {                $(e).closest('.form-group').removeClass('has-error').addClass('has-info');                $(e).remove();            },            errorPlacement: function (error, element) {                if (element.is(':checkbox') || element.is(':radio')) {                    var controls = element.closest('div[class*="col-"]');                    if (controls.find(':checkbox,:radio').length > 1) controls.append(error);                    else error.insertAfter(element.nextAll('.lbl:eq(0)').eq(0));                }                else if (element.is('.select2')) {                    error.insertAfter(element.siblings('[class*="select2-container"]:eq(0)'));                }                else if (element.is('.chosen-select')) {                    error.insertAfter(element.siblings('[class*="chosen-container"]:eq(0)'));                }                else error.insertAfter(element.parent());            },            submitHandler: function (form) {            },            invalidHandler: function (form) {            }        });        $('.create').on('click', function () {            formData = {};            showDialog(dialogObj, '新增角色信息', validate, formObj, formData);        });        $('.refresh').on('click', function () {            //grid.trigger("reloadGrid", {fromServer: true, page: 1});            drawGrid(grid,{fromServer: true, page: 1});        });    });    function formatOptions(cellvalue, options, rowObject) {        var s = '<div style="margin-left:8px;">';        var sign = rowObject.entity.sign;        if (sign) {            s += '<div title="编辑角色" style="float:left;" class="ui-pg-div ui-inline-del" onclick="editRole(\'' + rowObject.entity.id + '\');">';            s += '<i class="ui-icon fa fa-pencil"></i></div>';            s += '<div title="删除角色" style="float:left;" class="ui-pg-div ui-inline-del" onclick="deleteRole(\'' + rowObject.entity.id + '\');">';            s += '<i class="ui-icon fa fa-trash red"></i></div>';            s += '<div title="设置菜单" style="float:left;" class="ui-pg-div ui-inline-del" onclick="addMenu(\'' + rowObject.entity.id + '\');">';            s += '<i class="ui-icon fa fa-cog"></i></div>';        } else if (rowObject.entity.url) {            var rowId = options.rowId;            var ids = rowId.split('_');            s += '<div title="设置角色菜单权限" style="float:left;" class="ui-pg-div ui-inline-del" onclick="addRoleMenuPermission(\'' + ids[2] + '\',\'' + rowObject.entity.id + '\',\'' + rowObject.entity.url + '\');">';            s += '<i class="ui-icon fa fa-cogs bigger-110"></i></div>';        }        s += '</div>';        return s;    }    function editRole(id) {        formData = getCollectionData(_data, 'id', id).entity;        showDialog(dialogObj, '修改角色信息', validate, formObj, formData);    }    function addMenu(id) {        var url = "/core/roleMenu/query";        roleId = id;        var data = {"roleId": roleId, "parent": '0'};        http.getJSON(url, data, function (r) {            if (r) {                initMenuTree(r);            }        });        $(roleMenuDialog).modal('show');    }    function initMenuTree(data) {        var dataSource1 = function (options, callback) {            var $data = null;            if (!("text" in options) && !("type" in options)) {                //var dataSource = initData({data: result});                $data = data;//the root tree                callback({data: $data});                return;            }            else if ("type" in options && options.type === "folder") {                if ("additionalParameters" in options && "children" in options.additionalParameters)                    $data = options.additionalParameters.children || {};                else $data = {}//no data            }            if ($data !== null)//this setTimeout is only for mimicking some random delay                setTimeout(function () {                    callback({data: $data});                }, parseInt(Math.random() * 500) + 200);        };        treeObj = $(menuTree).ace_tree({            dataSource: dataSource1,            multiSelect: true,            cacheItems: true,            expandAll: true,            'open-icon': 'ace-icon tree-minus',            'close-icon': 'ace-icon tree-plus',            'itemSelect': true,            'folderSelect': false,            'selected-icon': 'ace-icon fa fa-check',            'unselected-icon': 'ace-icon fa fa-times',            loadingHTML: '<div class="tree-loading"><i class="ace-icon fa fa-refresh fa-spin blue"></i></div>'        });    }    function addRoleMenuPermission(roleId, menuId, menuUrl) {        currRoleId = roleId;        currMenuId = menuId;        var url = '/core/roleMenuPermission/query';        var data = {roleId: currRoleId, menuId: currMenuId};        http.getJSON(url, data, function (r) {            if (r) {                var html = '';                var i = 1;                html += '<div class="row">';                var j = 0;                $.each(r, function () {                    var item = this;                    html += '    <div class="col-xs-12 col-sm-6">';                    html += '       <div class="checkbox">';                    html += '           <label>';                    if (item.checked) {                        j++;                        html += '               <input name="roleId" type="checkbox" data-sign="' + menuUrl + ":" + item.permissionSign + '" class="ace role-menu-permission-checkbox" value="' + item.permissionId + '" checked>';                    } else {                        html += '               <input name="roleId" type="checkbox" data-sign="' + menuUrl + ":" + item.permissionSign + '" class="ace role-menu-permission-checkbox" value="' + item.permissionId + '">';                    }                    html += '               <span class="lbl"> ' + item.permissionName + '</span>';                    html += '           </label>';                    html += '       </div>';                    html += '      </div>';                    if (i % 2 === 0) {                        html += '</div>';                        html += '<div class="row">';                    }                    i++;                });                $('.role-menu-permission-list').html(html);                if (j === r.length) {                    //$('#checkAllPermissionData').checked = true;                }                $('#checkAllPermissionData').on('click', function () {                    var permissionCheck = this;                    $('.role-menu-permission-list input[type="checkbox"]').each(function (i, item) {                        item.checked = permissionCheck.checked;                    });                });                $('.role-menu-permission-checkbox').on('click', function () {                    if (!this.checked) {                        if ($('#checkAllPermissionData')[0].checked)                            $('#checkAllPermissionData')[0].checked = false;                    } else {                        var checkLen = $('.role-menu-permission-list input[type="checkbox"]:checked').length;                        if (checkLen === r.length) {                            $('#checkAllPermissionData')[0].checked = true;                        }                    }                })            }        });        $(roleMenuPermissionDialog).modal('show');    }    function deleteRole(id) {        confirmDialog('确定要删除该角色信息吗？', '信息删除', function (result) {            if (result) {                http.getJSON('/core/role/delete/' + id, function (r) {                    //$(grid_selector).trigger("reloadGrid", {fromServer: true, page: 1});                    drawGrid(grid,{fromServer: true, page: 1});                    showSuccessTips("角色信息删除成功.");                });            }        });    }</script></body></html>